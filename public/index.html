<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" type="image/png" href="./assets/images/favicon.png">
    <title>Home</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./assets/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./assets/css/home.css">
    <link rel="stylesheet" type="text/css" href="./assets/css/navbar+footer.css">
    <link href="https://fonts.googleapis.com/css?family=Rajdhani|Crushed" rel="stylesheet"> </head>

<body>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <!-- Top NavBar -->
    <nav class="navbar navbar-toggleable-md">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
        <div class="container">
            <div class="col-4">
                <a class="navbar-brand" href="https://titanium-flash-171510.appspot.com/"><img src="./assets/images/modsfuseLogo.png"></a>
            </div>
            <div class="col-4"> </div>
            <div class="col-4 nav-right text-right" id="UserView">
                <a href="/auth/google"><img height="50px" src="./assets/images/gsignin.png"></a>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 main-content">
                <!-- The Carousel -->
                <div data-ride="carousel" class="carousel carousel-fade" id="carousel-example-captions">
                    <ol class="carousel-indicators">
                        <li data-slide-to="0" data-target="#carousel-example-captions"></li>
                        <li data-slide-to="1" data-target="#carousel-example-captions" class=""></li>
                        <li data-slide-to="2" data-target="#carousel-example-captions" class=""></li>
                        <li data-slide-to="3" data-target="#carousel-example-captions" class=""></li>
                    </ol>
                    <div role="listbox" class="carousel-inner">
                        <div class="carousel-item active"> <img class="d-block img-fluid" src="./assets/images/index/slide0.png" alt="First slide"> </div>
                        <div class="carousel-item" role="listbox"> <img class="d-block img-fluid" src="./assets/images/index/slide1.png" alt="Second slide"> </div>
                        <div class="carousel-item" role="listbox"> <img class="d-block img-fluid" src="./assets/images/index/slide2.png" alt="Third slide"> </div>
                        <div class="carousel-item" role="listbox"> <img class="d-block img-fluid" src="./assets/images/index/slide3.png" alt="Fourth Image"> </div>
                    </div>
                    <a data-slide="prev" role="button" href="#carousel-example-captions" class="left carousel-control"> <span aria-hidden="true" class="icon-prev"></span> <span class="sr-only">Previous</span> </a>
                    <a data-slide="next" role="button" href="#carousel-example-captions" class="right carousel-control"> <span aria-hidden="true" class="icon-next"></span> <span class="sr-only">Next</span> </a>
                </div>
                <div class="banner">
                    <div class="featured">
                        <h1>FEATURED SHOPS</h1>
                        <div class="row" id="dynamicAlloc">
                            <div class=" col-12 col-md-3" id="DynamicTag">
                                <div class="card" style="width: 20rem;">
                                    <div class="card-header" id="Name"> Shop Name </div>
                                    <a id="Dynamic_Url" href=""><img class="card-img-top" id="Images" src="./assets/shop1.jpg" alt="Could Not Load"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "sub-banner">
                        <img src="./assets/images/modsfuseLogo.png" width="40%" height="40%">
                        <h2 class="slogan"><b>YOU DEMAND,WE CUSTOMISE</b></h2>
                        <p class="intro">Mods Fusion is the first online 3d customisation hub affiliated with the top customisation shops and private organizations currently providing you with the best car customization deals in town all around the Delhi NCR region.</p>
                        <a href="/locationSearch"><button type="button" class="btn btn-lg btn1">Get Started</button></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4 col-sm-6 footerleft ">
                    <div class="logofooter"><img src="./assets/images/modsfuseLogo.png" style="height: 65px; width: 200px;"></div>
                    <p>Contact Us for any queries or investments - </p>
                    <p><i class="fa fa-map-pin"></i> Adress - not available</p>
                    <p><i class="fa fa-phone"></i> Phone (India) : not available</p>
                    <p><i class="fa fa-envelope"></i> E-mail : 1developer.mail@gmail.com</p>
                </div>
                <div class="col-md-2 col-sm-6 paddingtop-bottom">
                    <h6 class="heading7">GENERAL LINKS</h6>
                    <ul class="footer-ul">
                        <li><a href="#"> Privacy Policy</a></li>
                        <li><a href="#"> Terms &amp; Conditions</a></li>
                        <li><a href="#"> Return Policy</a></li>
                        <li><a href="#"> Frequently Ask Questions</a></li>
                    </ul>
                </div>
                <div class="col-md-3 col-sm-6 paddingtop-bottom">
                    <h6 class="heading7">LATEST POST</h6>
                    <div class="post">
                        <p>Some Post Data<span>March 13,2017</span></p>
                        <p>Some Post Data<span>March 13,2017</span></p>
                        <p>Some Post Data<span>March 13,2017</span></p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 paddingtop-bottom">
                    <h6 class="heading7">SOCIAL MEDIA</h6>
                    <blockquote class="blockquote">
                        <blockquote cite="https://www.facebook.com/facebook"><a href="https://www.facebook.com/onedeveloper.1">Facebook</a></blockquote>
                        <blockquote cite="https://twitter.com/mods_fusion"><a href="https://www.twitter.com/">Twitter</a></blockquote>
                    </blockquote>
                </div>
            </div>
        </div>
    </footer>
    <!--Footer2-->
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>Â© 2017 - All Rights with Project X</p>
                </div>
                <div class="col-md-6">
                    <ul class="bottom_ul">
                        <li><a href="http://enactus.org/">projectx.org</a></li>
                        <li><a href="#">About us</a></li>
                        <li><a href="http://enactus.org/blog/">Blog</a></li>
                        <li><a href="#">Faq's</a></li>
                        <li><a href="#">Contact us</a></li>
                        <li><a href="#">Site Map</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
    <!--firebase-->
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <!--jquery-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <!--tether-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <!--bootstrap-->
    <script src="./assets/js/index.js"></script>
<script id="modifiable">
       /* var Ser_comLoadDat = [{
                        "Name": "Auto Marg"
                        , "Dynamic_Url": "rkxVUpY5rZ"
                        , "Images": "./assets/shop1.jpg,https://storage.googleapis.com/titanium-flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_audi Q7.PNG,https://storage.googleapis.com/titanium-flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_Xlogo.png"
        }, {
                        "Name": "Vasant Marg"
                        , "Dynamic_Url": "rkxVUpY5rZ"
                        , "Images": "./assets/shop1.jpg,https://storage.googleapis.com/titanium-flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_audi Q7.PNG,https://storage.googleapis.com/titanium- flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_Xlogo.png"
        }, {
                        "Name": "Marg Marg"
                        , "Dynamic_Url": "rkxVUpY5rZ"
                        , "Images": "./assets/shop1.jpg,https://storage.googleapis.com/titanium-flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_audi Q7.PNG,https://storage.googleapis.com/titanium- flash-171510.appspot.com/SHOPS/Auto Marg/shop_1/IMAGE_Xlogo.png"
        }];*/
                              
        //Shop Allocation
        var dynamicAlloc = document.getElementById('dynamicAlloc');
        var dynamicTag = document.getElementById('DynamicTag');
        //check if common variable is present or not
        if (typeof Ser_comLoadDat != 'undefined') {
            if(Ser_comLoadDat != 'Nothing to show........Please add some shops'){
                executeComUserFunc();
            }
        }
//      var xhttp = new XMLHttpRequest();
//  xhttp.onreadystatechange = function() {
//    if (this.readyState == 4 && this.status == 200) {
//      console.log(xhttp.responseText);
//    }
//  };
//    xhttp.open("POST", "/userUpload_firstPage", true);
//xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
//xhttp.send();
//    
    
        //DYNAMIC SHOP ARRANGEMENT
        function executeComUserFunc() {
            var countObj = Ser_comLoadDat.length;
            for (let i in Ser_comLoadDat) {
                var currentObj = Ser_comLoadDat[i];
                var objectKeys = Object.keys(currentObj);
                for (let j in objectKeys) {
                    var currentKey = objectKeys[j];
                    var currentTag = dynamicTag.querySelector('#' + currentKey);
                    feedTags(currentTag, currentObj[currentKey], function (newCurrentTag) {
                        console.log(newCurrentTag);
                    });
                }
                if (i == 0) {
                    dynamicTag = dynamicTag.cloneNode(true);
                }
                else {
                    dynamicAlloc.appendChild(dynamicTag);
                    dynamicTag = dynamicTag.cloneNode(true);
                }
            }
        }

        function feedTags(currentTag, tagValue, callback) {
            if (currentTag.tagName == 'IMG') {
                var tagValueArr = tagValue.split(',');
                if (Array.isArray(tagValueArr)) {
                    //currently using only first url of shop images
                    currentTag.setAttribute('src', tagValueArr[0]);
                    callback(currentTag);
                    return;
                }
                currentTag.setAttribute('src', tagValue);
                callback(currentTag);
            }
            else if (currentTag.tagName == 'A') {
                var createWebUrl = document.location.origin + '/' + 'dynamicShop' + '/' + tagValue
                currentTag.setAttribute('href', createWebUrl);
                callback(currentTag);
            }
            else if (currentTag.tagName == 'DIV' || currentTag.tagName == 'P') {
                currentTag.innerHTML = tagValue;
                callback(currentTag);
            }
            else {
                callback("tag not found.");
            }
        }
        
       //var Ser_logUserDat = [{"User_Email_Name": "Science Maniac","User_Picture":"./assets/images/user.jpg"}]
        if (typeof Ser_logUserDat != 'undefined') {
            executeLogUserFunc();
            loadUserData();
        }
        
        function loadUserData() {
            var userview = document.getElementById('UserView');
                
                var username = Ser_logUserDat[0]["User_Email_Name"];
                var userpic = Ser_logUserDat[0]["User_Picture"];
                var shopname = Ser_logUserDat[0]["Shop_User_Email_Name"];
                var shoppic = Ser_logUserDat[0]["Shop_User_Picture"];
                userview.innerHTML = '<img class = "userpic" src = ' + (userpic || shoppic) + '>';
                userview.innerHTML += '<h1 class = "username">' + (username || shopname) +'</h1>'; 
            
        }

        function executeLogUserFunc() {
            var getLoginKeys = Object.keys(Ser_logUserDat[0]);
            var splitLoginKeys = getLoginKeys[0].split('_')[0];
            //pass this to authorize the firebase on user login(after which it is deleted)      
            var idTokenName = splitLoginKeys + "_IdToken";
            //pass this value with every socket resquest to the server       
            var accessToken = splitLoginKeys + "_AccessToken";
            var callOnce = true;
            var FireBaseUser = null;
            //user creds for firebase 
            var configFirebase = {
                apiKey: "AIzaSyCB3xwPLgUI6O4AQQQYxW8PaZWsAcrXRq0"
                , authDomain: "titanium-flash-171510.firebaseapp.com"
                , databaseURL: "https://titanium-flash-171510.firebaseio.com"
                , projectId: "titanium-flash-171510"
                , storageBucket: "titanium-flash-171510.appspot.com"
                , messagingSenderId: "284593292198"
                , "gcm_sender_id": "103953800507"
            };
            
            firebase.initializeApp(configFirebase);
            var unsubscribe = firebase.auth().onAuthStateChanged(function (firebaseUser) {
                unsubscribe();
                //check if user is logged in to firebase or not
                if (isUserEqual(firebaseUser) == false || Ser_logUserDat[0][idTokenName] != null) {
                    var credential = firebase.auth.GoogleAuthProvider.credential(Ser_logUserDat[0][idTokenName]);
                    // Sign in with credential from the Google user.
                    firebase.auth().signInWithCredential(credential).then(function (result) {
                        //user successfully logged in to firebase
                        //listen to change in socket events
                        listeToSockets(result);
                    }).catch(function (error) {
                        //prompt user to login again
                    });
                }
                else {
                    //user already signed in
                    listeToSockets(firebaseUser);
                }
            });

            function listeToSockets(firebaseUser) {
                FireBaseUser = firebaseUser.uid;
                //listen to changes at specific socket id
                firebase.database().ref('Channels/Sockets/' + firebaseUser.uid).on('value', function (socketResponse) {
                    //delete id_token in database once the user is logged in
                    if (Ser_logUserDat[0][idTokenName] != null && callOnce == true) {
                        callOnce = false;
                        //call once the user is authorized
                        delIdToken(firebaseUser, accessToken, Ser_logUserDat[0][accessToken], idTokenName);
                    }
                    //get the results/values/response/data of the socket data request
                    console.log(socketResponse.val());
                    //remove the data from the firebase db to free the space once the data is recieved
                    firebase.database().ref('Channels/Sockets/' + firebaseUser.uid).remove();
                });
            }

            function delIdToken(firebaseUser, keyName, keyValue, keyNameToDelete) {
                var makeObj = {
                        Event_Name: "deleteTokValue"
                        , Array_info: [keyName, keyValue, keyNameToDelete]
                    }
                    //pass data to server at specific socket id(different for every user) to delete id_token(not to be confused with accessToken)
                firebase.database().ref('Channels/Sockets/' + firebaseUser.uid).set(makeObj);
            }

            function isUserEqual(firebaseUser) {
                if (firebaseUser) {
                    var providerData = firebaseUser.providerData;
                    console.log(firebase.auth.GoogleAuthProvider.PROVIDER_ID);
                    for (var i = 0; i < providerData.length; i++) {
                        console.log(providerData[i].providerId);
                        if (providerData[i].providerId === firebase.auth.GoogleAuthProvider.PROVIDER_ID) {
                            return true;
                        }
                    }
                }
                return false;
            }
        }
    </script>
</body>

</html>